<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order Form (Auto PDF)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#f7f7fb; --card:#fff; --ink:#111827; --muted:#6b7280; --brand:#0ea5e9; --ring:rgba(14,165,233,.35); --radius:16px; }
    * { box-sizing:border-box; }
    body { margin:0; background:var(--bg); color:var(--ink); font-family:'Inter',system-ui,Segoe UI,Roboto,Arial; }
    .wrap { max-width: 900px; margin: 24px auto; padding: 16px; }
    .card { background:var(--card); border-radius:var(--radius); padding: 20px; box-shadow:0 10px 24px rgba(0,0,0,.06); }
    header { display:flex; align-items:center; gap:16px; margin-bottom:8px; }
    header img { width:56px; height:56px; object-fit:contain; }
    h1 { font-size:22px; margin:0; }
    p.sub { color:var(--muted); margin:.25rem 0 1rem; }
    form { display:grid; grid-template-columns: repeat(6, 1fr); gap:12px; }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, textarea { width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; font-size:14px; outline:none; }
    input:focus { border-color:var(--brand); box-shadow:0 0 0 4px var(--ring);}
    .col-6 { grid-column: span 6; } .col-3 { grid-column: span 3; } .col-2 { grid-column: span 2; }
    .row { grid-column: 1 / -1; }
    .btns { display:flex; gap:10px; margin-top:4px; }
    button { appearance:none; border:0; border-radius:999px; padding:12px 18px; cursor:pointer; font-weight:600; }
    .primary { background:var(--brand); color:#fff; }
    .ghost { background:#eef6fb; color:#0369a1; }
    table.items { width:100%; border-collapse: collapse; }
    table.items th, table.items td { border-bottom:1px solid #e5e7eb; padding:10px; text-align:left; font-size:14px; }
    .status { margin-top:10px; font-size:14px; color:#0369a1; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <img src="logo.png" alt="Logo" onerror="this.style.display='none'"/>
        <div>
          <h1>PengYu - Order Form / 订单表单（自动生成PDF并发送邮件）</h1>
        </div>
      </header>

      <form id="orderForm">
        <div class="col-3"><label>Order No. / 订单号</label><input name="order_no" required placeholder="例如：314"/></div>
        <div class="col-3"><label>Order Date / 日期</label><input type="date" name="order_date" required/></div>
        <div class="col-3"><label>Customer Name / 客户姓名</label><input name="customer_name" required/></div>
        <div class="col-3"><label>Company / 公司</label><input name="company"/></div>
        <div class="col-3"><label>Email / 邮箱</label><input type="email" name="email" required/></div>
        <div class="col-3"><label>Phone / 电话</label><input name="phone"/></div>
        <div class="col-3"><label>Salesperson / 业务员</label><input name="salesperson"/></div>
        <div class="col-3"><label>PO Number / 采购单号</label><input name="po_number"/></div>
        <div class="col-3"><label>Bill To / 账单地址</label><input name="bill_to"/></div>
        <div class="col-3"><label>Ship To / 收货地址</label><input name="ship_to"/></div>

        <div class="row">
          <label>Items / 订购明细</label>
          <table class="items" id="itemsTable">
            <thead><tr><th>Qty 数量</th><th>Description 描述</th><th>Unit Price 单价</th><th>Line Total 小计</th><th>—</th></tr></thead>
            <tbody>
              <tr>
                <td><input name="item_qty_1" type="number" min="0" step="1" placeholder="0"/></td>
                <td><input name="item_desc_1" placeholder="e.g., coffee dispenser"/></td>
                <td><input name="item_unit_1" type="number" min="0" step="0.01" placeholder="0.00"/></td>
                <td><input name="item_total_1" type="number" min="0" step="0.01" placeholder="0.00"/></td>
                <td><button type="button" class="ghost" onclick="removeRow(this)">删除</button></td>
              </tr>
            </tbody>
          </table>
          <div class="btns"><button type="button" class="ghost" onclick="addRow()">+ 添加一行</button></div>
        </div>

        <div class="col-3"><label>Subtotal / 小计</label><input name="subtotal" type="number" step="0.01"/></div>
        <div class="col-3"><label>Sales Tax % / 税率</label><input name="tax_rate" type="number" step="0.01"/></div>
        <div class="col-3"><label>Freight / 运费</label><input name="freight" type="number" step="0.01"/></div>
        <div class="col-3"><label>Total / 合计</label><input name="total" type="number" step="0.01"/></div>

        <div class="col-6"><label>可选附件上传</label><input type="file" id="userFile"/></div>

        <div class="row btns">
          <button class="primary" type="submit">提交（自动生成PDF并寄送邮件）</button>
          <button class="ghost" type="reset">重置</button>
        </div>
        <div class="status" id="status"></div>
      </form>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
  const FORMSUBMIT = "https://formsubmit.co/tianyiyang77@gmail.com";

  function addRow() {
    const tbody = document.querySelector('#itemsTable tbody');
    const idx = tbody.children.length + 1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input name="item_qty_${idx}" type="number" min="0" step="1" placeholder="0"/></td>
      <td><input name="item_desc_${idx}" placeholder="Description"/></td>
      <td><input name="item_unit_${idx}" type="number" min="0" step="0.01" placeholder="0.00"/></td>
      <td><input name="item_total_${idx}" type="number" min="0" step="0.01" placeholder="0.00"/></td>
      <td><button type="button" class="ghost" onclick="removeRow(this)">删除</button></td>`;
    tbody.appendChild(tr);
  }
  function removeRow(btn) { btn.closest('tr').remove(); }

  function formToObject(form) {
    const data = {};
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(el => {
      if (el.type === 'file') return;
      if (el.name) data[el.name] = el.value;
    });
    return data;
  }

  function itemsToTable(form) {
    // Build a simple text table for PDF
    const rows = Array.from(form.querySelectorAll('#itemsTable tbody tr')).map(tr => Array.from(tr.querySelectorAll('input')).map(i => i.value));
    let text = "Qty | Description | Unit | Total\n";
    text += "----|-------------|------|------\n";
    rows.forEach(r => { text += `${r[0]||''} | ${r[1]||''} | ${r[2]||''} | ${r[3]||''}\n`; });
    return text;
  }

  async function createPdfBlob(form) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    const data = formToObject(form);
    const lines = [
      "PengYu - Order",
      "Order No.: " + (data.order_no||""),
      "Order Date: " + (data.order_date||""),
      "Customer: " + (data.customer_name||"") + "  Company: " + (data.company||""),
      "Email: " + (data.email||"") + "  Phone: " + (data.phone||""),
      "Salesperson: " + (data.salesperson||"") + "  PO: " + (data.po_number||""),
      "Bill To: " + (data.bill_to||""),
      "Ship To: " + (data.ship_to||""),
      "",
      "Items:",
      itemsToTable(form),
      "",
      "Subtotal: " + (data.subtotal||"") + "    Tax %: " + (data.tax_rate||"") + "    Freight: " + (data.freight||""),
      "TOTAL: " + (data.total||"")
    ];
    let y = 40;
    doc.setFont("helvetica","bold"); doc.setFontSize(16); doc.text("PengYu - Order Summary", 40, y); y += 24;
    doc.setFont("helvetica","normal"); doc.setFontSize(12);
    lines.forEach(line => { 
      const split = doc.splitTextToSize(line, 520);
      split.forEach(s => { doc.text(s, 40, y); y += 16; });
    });
    return doc.output("blob");
  }

  document.getElementById('orderForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const status = document.getElementById('status');
    status.textContent = "正在生成PDF并发送……";
    try {
      const form = e.currentTarget;
      const pdfBlob = await createPdfBlob(form);
      const fd = new FormData();
      // Plain fields
      const data = formToObject(form);
      Object.keys(data).forEach(k => fd.append(k, data[k]));

      // Attach generated PDF
      fd.append("attachment", pdfBlob, `order_${data.order_no||'no'}.pdf`);

      // Attach user-selected file if any
      const userFile = document.getElementById('userFile').files[0];
      if (userFile) fd.append("attachment", userFile, userFile.name);

      // FormSubmit special fields
      fd.append("_subject", "New Order - PengYu Global (PDF attached)");
      fd.append("_template", "table");
      fd.append("_captcha", "true");

      const resp = await fetch(FORMSUBMIT, { method:'POST', body: fd });
      if (!resp.ok) throw new Error("Email service responded with " + resp.status);
      status.textContent = "提交成功！请检查邮箱。";
      setTimeout(() => window.location.href = "https://tianyiy519.github.io/order-form/thank-you.html", 800);
    } catch (err) {
      console.error(err);
      status.textContent = "发送失败：" + err.message + "（可重试或稍后再试）";
    }
  });
</script>
</body>
</html>
